<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.uhi.gourmet.store.StoreMapper">

    <sql id="criteria">
        <trim prefix="AND (" suffix=")" prefixOverrides="OR">
            <if test="cri.category != null and cri.category != ''">
                s.store_category = #{cri.category}
            </if>
            <if test="cri.region != null and cri.region != ''">
                AND s.store_addr1 LIKE '%' || #{cri.region} || '%'
            </if>
            <if test="cri.keyword != null and cri.keyword != ''">
                AND s.store_name LIKE '%' || #{cri.keyword} || '%'
            </if>
        </trim>
    </sql>

    <select id="getListStore" resultType="com.uhi.gourmet.store.StoreVO">
        <![CDATA[
        SELECT * FROM (
            SELECT /*+ INDEX_DESC(STORE PK_STORE) */
                rownum AS rn, 
                inner_s.*
            FROM (
                SELECT 
                    s.*,
                    (SELECT COUNT(*) FROM REVIEW r WHERE r.store_id = s.store_id) as review_cnt,
                    (SELECT NVL(ROUND(AVG(rating), 1), 0) FROM REVIEW r WHERE r.store_id = s.store_id) as avg_rating
                FROM STORE s
                WHERE 1=1
        ]]>
        <include refid="criteria" />
        <![CDATA[
                ORDER BY s.store_id DESC
            ) inner_s
            WHERE rownum <= #{cri.pageNum} * #{cri.amount}
        )
        WHERE rn > (#{cri.pageNum} - 1) * #{cri.amount}
        ]]>
    </select>

    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) 
        FROM STORE s
        WHERE 1=1
        <include refid="criteria" />
    </select>

    <select id="selectPopularStore" resultType="com.uhi.gourmet.store.StoreVO">
        SELECT * FROM (
            SELECT 
                s.*,
                (SELECT COUNT(*) FROM REVIEW r WHERE r.store_id = s.store_id) as review_cnt,
                (SELECT NVL(ROUND(AVG(rating), 1), 0) FROM REVIEW r WHERE r.store_id = s.store_id) as avg_rating
            FROM STORE s
            ORDER BY s.store_cnt DESC
        )
        WHERE ROWNUM &lt;= 6
    </select>

    <select id="getStoreDetail" parameterType="int" resultType="com.uhi.gourmet.store.StoreVO">
        SELECT
            s.*,
            (SELECT COUNT(*) FROM REVIEW r WHERE r.store_id = s.store_id) as review_cnt,
            (SELECT NVL(ROUND(AVG(rating), 1), 0) FROM REVIEW r WHERE r.store_id = s.store_id) as avg_rating
        FROM STORE s
        WHERE s.store_id = #{store_id}
    </select>

    <insert id="insertStore" parameterType="com.uhi.gourmet.store.StoreVO">
        INSERT INTO STORE (
            store_id, user_id, store_name,
            store_tel, store_zip,
            store_addr1, store_addr2, store_lat, store_lon,
            store_category, store_desc, open_time, close_time,
            res_unit, store_img,
            store_cnt
        ) VALUES (
            SEQ_STORE.NEXTVAL,
            #{user_id, jdbcType=VARCHAR},
            #{store_name, jdbcType=VARCHAR},
            #{store_tel, jdbcType=VARCHAR},
            #{store_zip, jdbcType=VARCHAR},
            #{store_addr1, jdbcType=VARCHAR},
            #{store_addr2, jdbcType=VARCHAR},
            #{store_lat, jdbcType=NUMERIC},
            #{store_lon, jdbcType=NUMERIC},
            #{store_category, jdbcType=VARCHAR},
            #{store_desc, jdbcType=CLOB},
            #{open_time, jdbcType=VARCHAR},
            #{close_time, jdbcType=VARCHAR},
            #{res_unit, jdbcType=INTEGER},
            #{store_img, jdbcType=VARCHAR},
            0
        )
    </insert>

    <select id="getStoreByUserId" parameterType="string" resultType="com.uhi.gourmet.store.StoreVO">
        SELECT * FROM STORE WHERE user_id = #{user_id}
    </select>

    <select id="getMenuList" parameterType="int" resultType="com.uhi.gourmet.store.MenuVO">
        SELECT * FROM MENU WHERE store_id = #{store_id} ORDER BY menu_id ASC
    </select>

    <update id="updateViewCount" parameterType="int">
        UPDATE STORE SET store_cnt = store_cnt + 1 WHERE store_id = #{store_id}
    </update>

    <update id="updateStore" parameterType="com.uhi.gourmet.store.StoreVO">
        UPDATE STORE
        SET store_name = #{store_name, jdbcType=VARCHAR},
            store_category = #{store_category, jdbcType=VARCHAR},
            store_tel = #{store_tel, jdbcType=VARCHAR},
            store_addr1 = #{store_addr1, jdbcType=VARCHAR},
            store_addr2 = #{store_addr2, jdbcType=VARCHAR},
            store_zip = #{store_zip, jdbcType=VARCHAR},
            store_lat = #{store_lat, jdbcType=NUMERIC},
            store_lon = #{store_lon, jdbcType=NUMERIC},
            open_time = #{open_time, jdbcType=VARCHAR},
            close_time = #{close_time, jdbcType=VARCHAR},
            res_unit = #{res_unit, jdbcType=INTEGER},
            store_desc = #{store_desc, jdbcType=CLOB},
            store_img = #{store_img, jdbcType=VARCHAR}
        WHERE store_id = #{store_id}
    </update>

    <insert id="insertMenu" parameterType="com.uhi.gourmet.store.MenuVO">
        INSERT INTO MENU (
            menu_id, store_id, menu_name,
            menu_price, menu_img, menu_sign
        ) VALUES (
            SEQ_MENU.NEXTVAL,
            #{store_id, jdbcType=NUMERIC},
            #{menu_name, jdbcType=VARCHAR},
            #{menu_price, jdbcType=NUMERIC},
            #{menu_img, jdbcType=VARCHAR},
            #{menu_sign, jdbcType=VARCHAR}
        )
    </insert>

    <delete id="deleteMenu" parameterType="int">
        DELETE FROM MENU WHERE menu_id = #{menu_id}
    </delete>

    <update id="updateMenu" parameterType="com.uhi.gourmet.store.MenuVO">
        UPDATE MENU
        SET menu_name = #{menu_name, jdbcType=VARCHAR},
            menu_price = #{menu_price, jdbcType=NUMERIC},
            menu_img = #{menu_img, jdbcType=VARCHAR},
            menu_sign = #{menu_sign, jdbcType=VARCHAR}
        WHERE menu_id = #{menu_id, jdbcType=NUMERIC}
    </update>

    <select id="getMenuDetail" parameterType="int" resultType="com.uhi.gourmet.store.MenuVO">
        SELECT * FROM MENU WHERE menu_id = #{menu_id}
    </select>

    <select id="getBookedTimes" resultType="string">
        SELECT TO_CHAR(book_date, 'HH24:MI')
        FROM BOOK
        WHERE store_id = #{store_id}
          AND TO_CHAR(book_date, 'YYYY-MM-DD') = #{book_date}
        AND book_status NOT IN ('CANCELED', 'NOSHOW')
    </select>
</mapper>